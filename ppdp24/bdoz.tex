\begin{fpfig}[t]{2-Party Multiplication Circuit using Beaver Triples and BDOZ message authentication.}{fig-bdoz}
{\footnotesize
  \begin{verbatimtab}
    macsum(s1,s2)
    { { share = s1.share + s2.share; mac = s1.mac + s2.mac } }
    
    maccsum(s,c)
    { { share = s.share + c; mac = s.mac + c } }
    
    macctimes(s,c)
    { { share = s.share * c; mac = s.mac * c } }
    
    macshare(w) { {  share = r[w++"s"]; mac = r[w++"m"] } }

    mack(w) { r[++"k"] }
    
    auth(s,m,k,i) { assert(m = k + r[delta] * s)@i }
    
    secopen(w1,w2,w3,i1,i2)
    {
      let locsum =  macsum(macshare(w1), macshare(w2)) in
      m[w3++"s"]@i1 := (locsum.share)@i2;
      m[w3++"m"]@i1 := (locsum.mac)@i2;
      auth(m[w3++"s"],m[w3++"m"],mack(w1) + mack(w2),i1);
      m[w3]@i1 := (m[w3"s"] + (locsum.share))@i1
    }

    secreveal(s,k,w,i1,i2)
    {
      p[w++"s"] = s.share@i2;
      p[w++"m"] = s.mac@i2;
      auth(p[w++"s"],[w++"m"],k,i1)    
    }

    secopen("a","x","d",1,2);
    secopen("a","x","d",2,1);
    secopen("b","y","e",1,2);
    secopen("b","y","e",2,1);
    let xyshare = 
    let xys =
      macsum(macctimes(macshare("b"), m["d"]),
             macsum(macctimes(macshare("a"), m["e"]),
                    macshare("c")))
    in
    let xyk = mack("b") * m["d"] + mack("d") * m["d"] + mack("c")               
    in
    secreveal(xys,xyk,"1",1,2);
    secreveal(maccsum(xys,m["d"] * m["e"]),
              xyk - m["d"] * m["e"],
              "2",2,1);
    out@1 = (p[1++"s"] + p[2++"s"])@1;
    out@2 = (p[1++"s"] + p[2++"s"])@2;
  \end{verbatimtab}
}
\end{fpfig}

    
