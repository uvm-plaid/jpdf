\section{Share Types}

\newcommand{\sharety}{\mathrm{shares}}
\newcommand{\pubty}{\mathrm{public}}
\newcommand{\genshares}{\mathrm{genshares}}
\newcommand{\recon}{\mathrm{recon}}
\newcommand{\xvec}{\upsilon}
\newcommand{\xdefs}{\mathcal{D}}
\newcommand{\kwas}{\ \mathrm{as}\ }
\newcommand{\shtrip}[3]{#1 \Vdash #2 \rhd #3}
\newcommand{\redxsub}{\varrho}

\subsection{Logical Rules for $\minifed$}

\begin{eqnarray*}
  \genshares(\phi,y,\cid) &\defeq& \setit{\rx{y}{\cid}}, [\phi - \rx{y}{\cid}, \rx{y}{\cid}]\\
  \recon(\phi_1,\phi_2) &\defeq& \phi_1 \fplus \phi_2
\end{eqnarray*}
  
\begin{mathpar}
  \inferrule[Share]
      {\eqs \models \genshares(\phi_1,y,\cid) \eop R_2,[\mx{z}{\cid},\phi_2] }
      {\Gamma,R_1,\eqs \vdash [\mx{z}{\cid}] : R_1;R_2, \Gamma; [\mx{z}{\cid},\phi_2] : \sharety}

  \inferrule[Open]
      {\Gamma, \eqs \vdash [\px{y},\px{z}] : \sharety}
      {\Gamma,R,\eqs \vdash [\px{y},\px{z}] : R, \Gamma; [\recon(\px{y},\px{z})] : \pubty}

  \inferrule[Seq]
      {\Gamma_1,\eqs,R_1 \vdash \xvec_1 : R_2,\Gamma_2 \\
        \Gamma_2,\eqs,R_2 \vdash \xvec_2 : R_3,\Gamma_3}
      {\Gamma_1, \eqs,R_1 \vdash \xvec_1\xvec_2 : R_3,\Gamma_3}
\end{mathpar}

\begin{mathpar}
  \inferrule[Hyp]
      {}
      {\Gamma,\eqs \vdash \xvec : \Gamma(\xvec)}

  \inferrule[HEAdd]
      {\Gamma,\eqs \vdash [\phi^1_1,\phi^1_2] : \sharety\\
        \Gamma,\eqs \vdash [\phi^2_1,\phi^2_2] : \sharety}
      {\Gamma,\eqs \vdash [\phi^1_1\fplus\phi^2_1,\phi^1_2\fplus\phi^2_2] : \sharety}

  \inferrule[HEAddPub]
      {\Gamma,\eqs \vdash [\phi] : \pubty\\
        \Gamma,\eqs \vdash [\phi_1,\phi_2] : \sharety}
      {\Gamma,\eqs \vdash [\phi_1\fplus\phi,\phi_2] : \sharety}
            
  \inferrule[HEMultPub]
      {\Gamma,\eqs \vdash [\phi] : \pubty\\
        \Gamma,\eqs \vdash [\phi_1,\phi_2] : \sharety}
      {\Gamma,\eqs \vdash [\phi_1\ftimes\phi,\phi_2\ftimes\phi] : \sharety}

  \inferrule[PubOp]
      {\Gamma,\eqs \vdash [\phi_1] : \pubty\\
        \Gamma,\eqs \vdash [\phi_2] : \pubty}
      {\Gamma,\eqs \vdash [\phi_1\bop\phi_2] : \pubty}
\end{mathpar}

\subsection{Algorithmic Rules for $\metaprot$}


\begin{mathpar}
  %\inferrule[Assert]
  %    {}
  %    {\htrip{\mx{e^1_1}{e^1_2} \eop \phi - \rx{y}{\cid} \wedge
  %            \mx{e^2_1}{e^2_2} \eop \rx{y}{\cid}}
  %           {[\mx{e^1_1}{e^1_2},\mx{e^2_1}{e^2_2}] \kwas \genshares(\phi,y,\cid)}{\eqtrue}}
  \inferrule[CoerceShares]
      {}
      {\htrip{e_1 \eop \notg{\phi} - \rx{e}{e'} \wedge e_2 \eop \rx{e}{e'}}
             {[e_1,e_2] \kwas \genshares(\notg{\phi},e,e')}{\eqtrue}}
      
  %\inferrule[CoerceShares]
  %    {}
  %    {\htrip{e \eop e_1 \fplus e_2}{[e] \kwas \recon(e_1,e_2)}{\eqtrue}} 
\end{mathpar}

\begin{mathpar}
  \inferrule
      {e_1 \redx \mx{w_1}{\cid_1} \\ e_2 \redx \mx{w_2}{\cid_2} \\ e \redx w \\ e' \redx \cid}
      {\shtrip{\Gamma, R, \xdefs}
        {[e_1,e_2] \kwas \genshares(\notg{\phi},e,e')}
        {\Gamma;[\mx{w_1}{\cid_1},\mx{w_2}{\cid_2}] : \sharety, R;\setit{\rx{w}{\cid}}, \xdefs} }

  \inferrule
      {e_1 \redx \mx{w_1}{\cid_1} \\ e_2 \redx \mx{w_2}{\cid_2}  \\\\
        \Gamma,\eqtrue \vdash [\xdefs(\mx{w_1}{\cid_1} ), \xdefs(\mx{w_2}{\cid_2})] : \sharety}
      {\shtrip{\Gamma, R, \xdefs}{[e_2,e_2] : \sharety}{\Gamma;[\mx{w_1}{\cid_1},\mx{w_2}{\cid_2}] : \sharety,
          R, \xdefs}}

  \inferrule
      {e_1 \redx \px{w_1} \\ e_2 \redx \px{w_2}  \\
        \Gamma,\eqtrue \vdash [\xdefs(\px{w_1}), \xdefs(\px{w_2})] : \sharety}
      {\shtrip{\Gamma, R, \xdefs}{[e_2,e_2] : \pubty}{\Gamma;[\px{w_1} \fplus \px{w_2}] : \pubty,
          R, \xdefs}}

  \inferrule
      {e \redx \mx{w}{\cid} \\ \Gamma,\eqtrue \vdash [\xdefs(\mx{w}{\cid})] : \pubty}
      {\shtrip{\Gamma, R, \xdefs}{[e] : \pubty}{\Gamma;[\mx{w}{\cid}] : \pubty,
          R, \xdefs}}

  \inferrule
      {e_1 \redx \mx{w}{\cid_1} \\ e_2 \redx \elab{\be}{\cid_2}}
      {\shtrip{\Gamma, R, \xdefs}{e_1 := e_2}{\Gamma, R, \xdefs[\mx{w}{\cid_1} \mapsto \toeq{\elab{\be}{\cid_2}}]}}

  \inferrule
      {f : \Pi y_1,\ldots,y_n. \notg{\Gamma_1} \rightarrow (\notg{R'},\notg{\Gamma_2}) \\
       \redxsub = [e_1/y_1 \cdots e_n/y_n]}
      {\shtrip{\Gamma;\redxsub(\notg{\Gamma_1}), R, \xdefs}{f(e_1,\ldots,e_n)}{\Gamma;\redxsub(\notg{\Gamma_2}), R;\redxsub(\notg{R'}), \xdefs}}

  \inferrule        
      {\shtrip{\Gamma_1,R_1,\xdefs_1}{\cmd_1}{\Gamma_2,R_2,\xdefs_2} \\
       \shtrip{\Gamma_2,R_2,\xdefs_2}{\cmd_2}{\Gamma_3,R_3,\xdefs_3}}
      {\shtrip{\Gamma_1,R_1,\xdefs_1}{\cmd_1;\cmd_2}{\Gamma_3,R_3,\xdefs_3}}

  \inferrule[Let]
      {\shtrip{\Gamma_1,R_1,\xdefs_1}{\cmd[e/y]}{\Gamma_2,R_2,\xdefs_2}}
      {\htrip{\Gamma_1,R_1,\xdefs_1}{\elet{y}{e}{\cmd}}{\Gamma_2,R_2,\xdefs_2}}
\end{mathpar}

$$
\inferrule
    {\codebase(f) = y_1 : \tau_1, \ldots, y_n : \tau_n, \cmd \\ \mv_1,\ldots,\mv_n = \fresh(\tau_1,\ldots,\tau_n) \\
      \redxsub = [\mv_1/y_1 \cdots \mv_n/y_n] \\
     \shtrip{\redxsub(\notg{\Gamma_1}), \varnothing, \varnothing}{\cmd}{\redxsub(\notg{\Gamma_2}), \redxsub(\notg{R}),\xdefs}}
    {f : \Pi y_1,\ldots,y_n. \notg{\Gamma_1} \rightarrow (\notg{R},\notg{\Gamma_2})}
$$

    Note: $\xdefs$ is a mapping from $x$s to $\phi$s (their ``definitions''). ``Evaluating substitution'' $\redxsub(\notg{R}),\redxsub(\notg{\Gamma})$ is defined to impose evaluation (probably $\peq$ as well). I.e., given $\redxsub = [e_1/y_1 \cdots e_n/y_n]$:
    $$
    \redxsub(\notg{\Gamma}) = \Gamma \ \text{where}\ \notg{\Gamma}[e_1/y_1 \cdots e_n/y_n] \redx \Gamma
    $$
    and so on.
