\renewcommand{\unity}[2]{U(#1, #2)}
\renewcommand{\ty}{T}
\newcommand{\eset}{D}
\newcommand{\dty}[2]{\langle #1, #2 \rangle}
\newcommand{\sharet}[1]{\mathrm{shares}(#1)}
\newcommand{\cvec}[1]{[#1]}
\newcommand{\secopent}{\mathrm{secopen}}
\newcommand{\declasst}[1]{\mathrm{declass}(#1)}
\renewcommand{\view}{\mathit{view}}
\newcommand{\revealed}{\mathit{revealed}}


\section{Declassification Typing}

$$
\begin{array}{rcl@{\hspace{4mm}}r}
\eset &\in& 2^{\phi} & \gdesc{Dependency Approximations}\\ 
\ty &::=& \dty{R}{\eset} & \gdesc{Probabilistic Types} \\
\Gamma &::=& \varnothing \mid \Gamma; x : \ty & \gdesc{Type Environments}
\end{array}
$$

\subsection{Primitive Typing Rules}

\begin{mathpar}
  \inferrule[Mesg]
            {}
            {\Gamma, \eqs \vdash \mx{w}{\cid} : \Gamma(\mx{w}{\cid})}
            
  \inferrule[Rand]
            {}
            {\Gamma, \eqs \vdash \rx{w}{\cid} : \dty{\setit{\rx{w}{\cid}}}{\varnothing}}
            
  \inferrule[Ideal]
            {}
            {\Gamma, \eqs \vdash f(\sx{w_1}{\cid_1},\ldots,\sx{w_n}{\cid_n}) :
              \dty{\varnothing}{\setit{f(\sx{w_1}{\cid_1},\ldots,\sx{w_n}{\cid_n})}}}

  \inferrule[Invert]
            {\Gamma, \eqs \vdash \phi : \ty}
            {\Gamma, \eqs \vdash -\phi : \ty}

  \inferrule[Join]
      {\Gamma, \eqs \vdash \phi_1 : \dty{R_1}{\eset_1}\\
       \Gamma, \eqs \vdash \phi_2 : \dty{R_2}{\eset_2}\\
        R \defeq (R_1 - (R_2 \cup \eset_2) \cup (R_2 - (R_1 \cup \eset_1)) \\ 
        \eset \defeq (R_1 \cup R_2 \cup \eset_1 \cup \eset_2) - R }
      {\Gamma, \eqs \vdash \phi_1 \fplus \phi_2 : \dty{R}{\eset}}

  \inferrule[Smear]
      {\Gamma, \eqs \vdash \phi_1 : \dty{R_1}{\eset_1}\\
       \Gamma, \eqs \vdash \phi_2 : \dty{R_2}{\eset_2}}
      {\Gamma, \eqs \vdash \phi_1 \bop \phi_2 : \dty{\varnothing}{R_1 \cup R_2 \cup \eset_1 \cup \eset_2}}

  \inferrule[Eq]
            {\eqs \models \phi \eop \phi' \\ \Gamma, \eqs \vdash \phi' : \ty}
            {\Gamma, \eqs \vdash \phi : \ty}          
\end{mathpar}

\begin{mathpar}
  \inferrule[Mesg]
      {\Gamma, \eqs \vdash \toeq{\elab{e}{\cid}} : \ty}
      {\Gamma, \eqs \vdash \xassign{x}{e}{\cid} : (\Gamma;x:\ty)}

  \inferrule[Seq]
      {\Gamma_1,\eqs \vdash \cmd_1 : \Gamma_2 \\
        \Gamma_2,\eqs \vdash \cmd_2 : \Gamma_3}
      {\Gamma_1, \eqs \vdash \cmd_1;\cmd_2 : \Gamma_3}
\end{mathpar}


\begin{definition}[Adversarial Views]
  Given $\prog, \eqs, \Gamma$ with $\toeq{\prog} \models \eqs$ and $\varnothing, \eqs \vdash \prog : \Gamma$.
  Then for all $H,C$, define:
  $$
  \view(\Gamma,\eqs,C,\prog) \defeq \bigcup_{X \in (\pow(\vars(\prog)_C)) - \varnothing} \ty
     \qquad \text{where}\ \Gamma,\eqs \vdash \Sigma_{x \in X} x : \ty
  $$
\end{definition}

\begin{definition}[Revelation]
  $$
  \begin{array}{ll}
    \revealed(\ty,H) \defeq & \setit{f(\sx{w_1}{\cid_1},\ldots,\sx{w_n}{\cid_n}) \mid  \\
      & \qquad \dty{\varnothing}{\eset} \in \ty\ \wedge\\
      & \qquad f(\sx{w_1}{\cid_1},\ldots,\sx{w_n}{\cid_n}) \in \eset\ \wedge \\
      & \qquad \exists 1 \le i \le n . \cid_i \in H} 
  \end{array}
  $$
\end{definition}

\begin{theorem}[Security Typing]
  Given $\prog, \eqs, \Gamma$ with $\toeq{\prog} \models \eqs$ and $\varnothing, \eqs \vdash \prog : \Gamma$.
  The $\prog$ satisfies {NIMO} for ideal functionality $\idealf$ if for all $H,C$, we have:
  $$
  \revealed(\view(\Gamma,\eqs,C,\prog),H) = \setit{\idealf}
  $$
\end{theorem}

\subsection{Strategies}

\begin{mathpar}
  \inferrule[Sharing]
      {
        \eqs \models \mx{w_1}{\cid_1} \fplus \cdots \fplus \mx{w_n}{\cid_n} \eop \phi \\
        \\
        \exists R\ .\ (\forall M \in \pow(\setit{\mx{w_1}{\cid_1},\ldots,\mx{w_n}{\cid_n}})\ .\ 0 < |M| < n \implies \\
          \qquad \Gamma, \eqs \vdash \Sigma_{x \in M} x : \unity{R'}{\eset} \ \wedge \ R' \subseteq R)
      }   
      {\Gamma,R,\eqs \vdash \cvec{\mx{w_1}{\cid_1},\ldots,\mx{w_n}{\cid_n}} : \sharet{\phi}}

  \inferrule[Homomorphic Addition]
      {
       \Gamma,R_1,\eqs \vdash \cvec{\mx{w^1_1}{\cid_1},\ldots,\mx{w^1_n}{\cid_n}} : \sharet{\phi_1} \\
       \Gamma,R_2,\eqs \vdash \cvec{\mx{w^2_1}{\cid_1},\ldots,\mx{w^2_n}{\cid_n}} : \sharet{\phi_2} \\
       \eqs \models \mx{w_1}{\cid_1} \eop \mx{w^1_1}{\cid_1} \fplus \mx{w^2_1}{\cid_1} 
       \ \ldots\ 
       \eqs \models \mx{w_n}{\cid_n} \eop \mx{w^1_n}{\cid_n} \fplus \mx{w^2_n}{\cid_n} 
      }
      {
        \Gamma, R_1;R_2, \eqs \vdash \cvec{\mx{w_1}{\cid_1},\ldots,\mx{w_n}{\cid_n}} : \sharet{\phi_1 \fplus \phi_2}
      }
      
 \inferrule[Secure Opening]
      {
        \Gamma,R_1,\eqs \vdash \cvec{\mx{w_1}{\cid_1},\ldots,\mx{w_n}{\cid_n}} : \sharet{\phi} \\
        \eqs \models \px{w_1} \eop \mx{w_1}{\cid_1}
        \ \ldots\
        \eqs \models \px{w_n} \eop \mx{w_n}{\cid_n}\\
        \Gamma,\eqs \vdash \phi : \unity{R_2}{\eset}
      }
      {
        \Gamma, R_1;R_2, \eqs \vdash \cvec{\px{w_1},\ldots,\px{w_n}} : \secopent
      }
      
 \inferrule[Declassification]
      {
        \Gamma,R,\eqs \vdash \cvec{\mx{w_1}{\cid_1},\ldots,\mx{w_n}{\cid_n}} : \sharet{\phi} \\
        \eqs \models \px{w_1} \eop \mx{w_1}{\cid_1}
        \ \ldots\
        \eqs \models \px{w_n} \eop \mx{w_n}{\cid_n}
      }
      {
        \Gamma, R, \eqs \vdash \cvec{\px{w_1},\ldots,\px{w_n}} : \declasst{\phi}
      }
\end{mathpar}



