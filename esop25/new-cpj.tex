\renewcommand{\unity}[2]{U(#1, #2)}
\renewcommand{\ty}{T}
\newcommand{\eset}{D}
\newcommand{\dty}[2]{\langle #1, #2 \rangle}
\newcommand{\sharet}[1]{\mathrm{shares}(#1)}

\section{Declassification Typing}

\subsection{Primitive Typing Rules}

\begin{mathpar}
  \inferrule[Mesg]
            {}
            {\Gamma, \eqs \vdash \mx{w}{\cid} : \Gamma(\mx{w}{\cid})}
            
  \inferrule[Rand]
            {}
            {\Gamma, \eqs \vdash \rx{w}{\cid} : \dty{\setit{\rx{w}{\cid}}}{\varnothing}}
            
  \inferrule[Ideal]
            {}
            {\Gamma, \eqs \vdash f(\sx{w_1}{\cid_1},\ldots,\sx{w_n}{\cid_n}) :
              \dty{\varnothing}{f(\sx{w_1}{\cid_1},\ldots,\sx{w_n}{\cid_n})}}

  \inferrule[Invert]
            {\Gamma, \eqs \vdash \phi : \ty}
            {\Gamma, \eqs \vdash -\phi : \ty}

  \inferrule[Join]
      {\Gamma, \eqs \vdash \phi_1 : \dty{R_1}{\eset_1}\\
       \Gamma, \eqs \vdash \phi_2 : \dty{R_2}{\eset_2}\\
        R \defeq (R_1 - (R_2 \cup \eset_2) \cup (R_2 - (R_1 \cup \eset_1)) \\ 
        \eset \defeq (R_1 \cup R_2 \cup \eset_1 \cup \eset_2) - R }
      {\Gamma, \eqs \vdash \phi_1 \fplus \phi_2 : \dty{R}{\eset}}

  \inferrule[Smear]
      {\Gamma, \eqs \vdash \phi_1 : \dty{R_1}{\eset_1}\\
       \Gamma, \eqs \vdash \phi_2 : \dty{R_2}{\eset_2}}
      {\Gamma, \eqs \vdash \phi_1 \fplus \phi_2 : \dty{\varnothing}{R_1 \cup R_2 \cup \eset_1 \cup \eset_2}}

  \inferrule[Eq]
            {\eqs \models \phi \eop \phi' \\ \Gamma, \eqs \vdash \phi' : \ty}
            {\Gamma, \eqs \vdash \phi : \ty}          
\end{mathpar}

\begin{mathpar}
  \inferrule[Mesg]
      {\Gamma, \eqs \vdash \toeq{\elab{e}{\cid}} : \ty}
      {\Gamma, \eqs \vdash \xassign{x}{e}{\cid} : (\Gamma;x:\ty)}

  \inferrule[Seq]
      {\Gamma_1,\eqs \vdash \cmd_1 : \Gamma_2 \\
        \Gamma_2,\eqs \vdash \cmd_2 : \Gamma_3}
      {\Gamma_1, \eqs \vdash \cmd_1;\cmd_2 : \Gamma_3}
\end{mathpar}

\subsection{Strategies}

\begin{mathpar}
  \inferrule[Sharing]
      {\exists R\ .\ \forall X \in \pow(\mx{w_1}{\cid_1},\ldots,\mx{w_n}{\cid_n})\ .\ |X| < n \implies \\
          \Gamma, \eqs \vdash \Sigma_{x \in X} x : \unity{R'}{\eset} \ \wedge \ R' \subseteq R  }   
      {\Gamma,R,\eqs \vdash \setit{\mx{w_1}{\cid_1},\ldots,\mx{w_n}{\cid_n}} : \sharet{\be}}
\end{mathpar}





\begin{comment}
\begin{mathpar}
  \inferrule[PassiveRecon]
      {\setit{(e_1,\unity{\rkey_1}), (e_2,\unity{\rkey_2})}  \subseteq K\\
       \rkey_1 \corr \rkey_2 \\
       \Gamma, R_2, \eqs \vdash e_1 \fplus e_2 : \ty}
      {\Gamma, \eqs \vdash K,R_1 \leadsto K \cup \ty,R_1;R_2}
      
  \inferrule[PassiveHEAdd]
      {\setit{(e_1,\unity{\rkey_1}), (e_n,\unity{\rkey_2})}  \subseteq K\\
       \uncorr{\rkey_1}{\rkey_2} }
      {\Gamma, \eqs \vdash K,R \leadsto K \cup \setit{(e_1 \fplus e_2,\unity{\rkey_1 \oplus \rkey_2})},R}
\end{mathpar}
\end{comment}


\begin{comment}
\section{Deprecated}

\begin{mathpar}
  \inferrule[Mesg]
            {}
            {\Gamma, \eqs \vdash x : \Gamma(x)}

  \inferrule[Key]
            {\sid:[\ldots,x_k,\ldots] \in \keys}
            {\Gamma, \eqs \vdash x_k : \setit{\sharet{\sid}{k}}}
            
  \inferrule[Secret]
            {}
            {\Gamma, \eqs \vdash \sx{w}{\cid} : \setit{\sx{w}{\cid}}}
            
  \inferrule[Join]
            {\Gamma, \eqs \vdash \phi_1 : \ty_1 \\ \Gamma, \eqs \vdash \phi_2 : \ty_2}
            {\Gamma, \eqs \vdash \phi_1 \bop \phi_2 : \ty_1 \cup \ty_2}
            
  \inferrule[Eq]
            {\eqs \models \phi \eop \phi' \\ \Gamma, \eqs \vdash \phi' : \ty}
            {\Gamma, \eqs \vdash \phi : \ty}

  \inferrule[Share]
            {\Gamma, \eqs \vdash x_1 : \sharet{\sid}{1} \\ \cdots \\ \Gamma, \eqs \vdash x_{n-1} : \sharet{\sid}{n-1} }
            {\Gamma, \eqs \vdash \phi - x_1 - \cdots - x_{n-1} : [\phi]_\sid}
            
  \inferrule[HeAdd]
      {\Gamma, \eqs \vdash \phi_1 : \setit{\sharet{\sexp_1}{k}} \\
       \Gamma, \eqs \vdash \phi_2 : \setit{\sharet{\sexp_2}{k}} }
      {\Gamma, \eqs \vdash \phi_1 \fplus \phi_2 : \setit{\sharet{\sexp_1 \oplus \sexp_2}{k}}}
\end{mathpar}

\begin{mathpar}
  \inferrule[Enc]
      {\Gamma, \eqs \vdash \toeq{\elab{e}{\cid}} : [\phi]_{\sid}}
      {\Gamma,\Shares,\eqs \vdash \xassign{x}{e}{\cid} : (\Gamma;x:\sharet{\sid}{n}),(\Shares;[\phi]_\sid)}

  \inferrule[Mesg]
      {\Gamma, \eqs \vdash \toeq{\elab{e}{\cid}} : \ty}
      {\Gamma,\Shares,\eqs \vdash \xassign{x}{e}{\cid} : (\Gamma;x:\ty),\Shares}

  \inferrule[Seq]
      {\Gamma_1,\Shares_1,\eqs \vdash \prog_1 : \Gamma_2,\Shares_2 \\
        \Gamma_2,\Shares_2,\eqs \vdash \prog_2 : \Gamma_3,\Shares_3}
      {\Gamma_1,\Shares_1,\eqs \vdash \prog_1;\prog_2 : \Gamma_3,\Shares_3}
\end{mathpar}

\begin{mathpar}
  \inferrule
      {}
      {\Shares \vdash T \cup \setit{\sx{w}{\cid}},C \leadsto T, C.\sx{w}{\cid}}
      
  \inferrule
      {}
      {\Shares \vdash T \cup \setit{\sharet{\sexp}{1},\ldots,\sharet{\sexp}{n}},C \leadsto T, C.\Shares(\sexp)}

  \inferrule
      {\setit{\sharet{\sexp_1 \oplus \sexp_2}{j}, \sharet{\sexp_1}{k}, \sharet{\sexp_2}{k}} \subseteq T}
      {\Shares \vdash T,C \leadsto T \cup \setit{\sharet{\sexp_1 \oplus \sexp_2}{k}},C}

  \inferrule
      {\Shares \vdash T_1,C_1 \leadsto T_2,C_2 \\ \Shares \vdash T_2,C_2 \leadsto T_3,C_3 }
      {\Shares \vdash T_1,C_1 \leadsto T_3,C_3 }
\end{mathpar}
\end{comment}
