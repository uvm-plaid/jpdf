\subsection{Share Type Checking with Annotations}

Share types rely on SMT entailments via the \TirName{ShareEntails} and \TirName{PubEntails} rules,
which are not syntax directed. Our goal with the $\metaprot$ language is to automate share type
checking. To enable this we introduce \emph{share type annotations} 

\stafig

\begin{definition}[Abstract Share Type Environments]
  We write $\notg{\Gamma}$ to denote sets of bindings $\notg{\stt} : \sty$, and
  $\notg{R}$ to denote sets of expressions (that evaluate to random variables).
  We define evaluation of these, respectively, as follows:
  \begin{mathpar}
  \inferrule
      {\notg{\stt}_1 \redx \stt_1 \cdots \notg{\stt}_n \redx \stt_n}
      {\setit{\notg{\stt}_1 : \sty_1, \ldots, \notg{\stt}_n : \sty_n} \redx
        \setit{\stt_1 : \sty_1, \ldots, \stt_n : \sty_n}}
      
  \inferrule
      {e_1 \redx \rx{w_1}{\cid_1} \cdots e_1 \redx \rx{w_n}{\cid_n}}
      {\setit{e_1,\ldots,e_n} \redx
        \setit{\rx{w_1}{\cid_1}, \ldots, \rx{w_n}{\cid_n}}}
  \end{mathpar}
\end{definition}

\shtripstafig

\shtripcmdfig



\begin{fpfig}[t]{GMW $\ttt{and}$ gate with share type annotations.}{fig-gmwsharetypes}
\begin{verbatimtab}
andgmw(z:string, x:string, y:string) {
  let table = andtablegmw(x,y,z) in
  m[z]@2 := OT4((m[x], m[y])@2, table.row4, table.row3, table.row2, table.row1)@1;
  m[z]@1 := r[z]@1;
  m[z]@2 as (RECON(x) * RECON(y)) + r[z]@1;
  [m[z]@1,m[z]@2] : shares
}
postcondition:  ( RECON(z) == RECON(x) * RECON(y))
\end{verbatimtab}
\end{fpfig}

\begin{definition} Define $\clean(\Gamma)$ as follows:
\begin{eqnarray*}
\clean(\varnothing) &=& \varnothing \\[-1.5mm]
\clean(\setit{[\mx{z}{\cid}, \mx{y}{\cid'}] : \sharety} \cup \Gamma) &=& \clean(\Gamma)\\[-1.5mm]
\clean(\setit{\pubx{\mx{z}{\cid}} : \pubty} \cup \Gamma) &=& \clean(\Gamma)\\[-1.5mm]
\clean(\setit{\stt : \sty} \cup \Gamma) &=& \setit{\stt : \sty} \cup \clean(\Gamma)
\end{eqnarray*}
\end{definition}

\begin{lemma}
  Assume $\cmd \redx \prog$ and $\htrip{\eqs_1 \wedge \toeq{\xdefs_1}}{\prog}{\eqs_2}$ and
  $\shtrip{\Gamma_1,R_1,\xdefs_1}{\cmd}{\Gamma_2,R_2,\xdefs_2}$ and   
  $\eqs_1 \wedge \toeq{\xdefs_1},\clean(\Gamma_1),R_1 : {OK}$.
  Then $\eqs_1 \wedge \toeq{\xdefs_1} \wedge \toeq{\prog} \vdash \clean(\Gamma_1),R_1 \stredx^* \clean(\Gamma_2),R_2$.
\end{lemma}

\begin{lemma}
  Assume $\htrip{\eqspre}{\ttt{main()}}{\eqs}$ and $\ttt{main} : \Gamma_1 \rightarrow (\Gamma_2,R)$
  and $\eqspre,\Gamma_1,R' : {OK}$ with $R' \cap R = \varnothing$. Given $\ttt{main()} \redx \prog$,
  then $\eqspre \wedge \toeq{\prog} \vdash \varnothing, \varnothing \stredx^* \clean(\Gamma_2),R$.
\end{lemma}

\begin{theorem}
  Assume $\htrip{\eqspre}{\ttt{main()}}{\eqs}$ and $\ttt{main} : \Gamma_1 \rightarrow (\Gamma_2,R)$
  and $\eqspre,\Gamma_1,R' : {OK}$ with $R' \cap R = \varnothing$. Given $\ttt{main()} \redx \prog$,
  with $\iov(\prog) = S \cup V \cup O$, then $\prog$ satisfies noninterference modulo output if
  $\realviews{\setit{\cid_1}}{\setit{\cid_2}} \cup O
  \subseteq \ov(\clean(\Gamma_2))$ for all $\cid_1$, $\cid_2$ with $\cid_1 \ne \cid_2$.
\end{theorem}

