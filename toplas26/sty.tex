\section{Share Types}
\label{section-sty}

Our approach to static analysis is to enforce the use of sound
techniques in semi-homorphic encryption in protocols.  As discussed in
the example in Section \ref{section-smt-example}, protocols integrate
interactive elements, such as the sharing of one-time-pad (OTP)
encrypted secrets, and noninteractive elements, such as addition (of
shares). We approach this by introducing distinct judgement forms for
interactive and noninteractive protocol elements. Our type system
as presented will assume 2-client protocols, but this is for
simplicity and the analysis can be generalized to more parties. 

Both interactive and non-interactive judgements leverage the use
of SMT interpretations as described in Section \ref{section-smt}.
We introduce a \emph{share type} language $\sty$, classifying
\emph{share terms}. We represent share terms using standard notation
\cite{10.1007/978-3-030-68869-1_3}. A share term $[\phi_1,\phi_2]$
represents a secret-shared value where client 1 has $\phi_1$ and
client 2 has $\phi_2$, and this shared value can be reconstructed
as $\phi_1 + \phi_2$.\cnote{Comment on generation and
  reconstruction in general somewhere.} A share term $\pubx{\phi}$
denotes a publicly shared value.
$$
\begin{array}{rcl@{\hspace{10mm}}l}
  \sty &::=& \sharety \mid \pubty \mid \outty & \textit{share types} \\
  \stt &::=& [\phi,\phi] \mid \pubx{\phi} & \textit{share terms} 
\end{array}
$$ We proceed by formally describing the type analysis, then
discussing an illustrative example, and finally by demonstrating share
type soundness (Theorem \ref{theorem-sty}).

\subsection{Non-Interactive Typing Rules} 

Our non-interactive typing rules are presented in Figure
\ref{fig-stylocal}. Judgmements are of the form $\Gamma, \eqs \vdash
\stt : \sty$, where $\Gamma$ is a set of \emph{share type bindings} of
the form $\stt : \sty$. In the context of typing a protocol $\prog$
soundness requires that the constraint $\eqs$ must be entailed by
$\eqspre \wedge \toeq{\prog}$ (see, e.g., Lemma
\ref{lemma-sty-noninteractive-sound}).

The syntax-directed rules all known semi-homomorphic operations,
including addition of shares (\TirName{HEAdd}), and both addition and
multiplication of shares with a public value (\TirName{HEAddPub} and
\TirName{HEMultPub}, respectively) \cite{10.1007/978-3-030-68869-1_3}.
These rules also leverage SMT entailment in the \TirName{ShareEntails}
and \TirName{PubEntails} rules, since these operations should be
allowable up to algebraic equivalence in the context of a protocol.

\stylocalfig

\subsection{Interactive Typing Rules} 

It is well-known that adding or subtracting a sample from a uniform
distribution in a finite field yields a value in a uniform
distribution, meaning that samples can be used as one-time-pads with
perfect secrecy \cite{barthe2019probabilistic,darais2019language}.

\styinteractivefig

\subsection{Share Typing Example} To illustrate details of the
type system we return to the example of additive sharing in the context
of a 2-client protocol. We first focus on initial secret sharing steps--
let $\prog$ be the following protocol in $\fieldp{2}$ (noting
that $-$ is equivalent to xor in $\fieldp{2}$):
$$
\begin{array}{lll}
  \elab{\mesg{s1}}{2} &:=& \elab{(\secret{1} \fminus \locflip)}{1}; \\
  \elab{\mesg{s2}}{1} &:=& \elab{(\secret{2} \fminus \locflip)}{2} 
\end{array}
$$
We can then assert:
$$
\toeq{\prog} \vdash \varnothing,\varnothing \stredx
\setit{[\mx{s2}{1}, \elab{\locflip}{2}] : \sharety,
  [\mx{s1}{2}, \elab{\locflip}{1}] : \sharety}, \setit{\elab{\locflip}{1},\elab{\locflip}{2}}
$$
Suppose the protocol goes on to reveal the negation of the
sum (xor-ing) of the inputs:
$$
\begin{array}{lll}
  \px{1} &:=& \elab{\mesg{s2} + \locflip + 1}{1}; \\
  \px{2} &:=& \elab{\mesg{s1} + \locflip}{2}\\
  \out{1} &:=& \elab{\px{1} + \px{2}}{1}\\
  \out{2} &:=& \elab{\px{1} + \px{2}}{2}
\end{array}
$$
Letting this extended protocol be $\prog'$, and letting:
$$
\begin{array}{rcl}
\Gamma &\defeq& \setit{[\mx{s2}{1}, \elab{\locflip}{2}] : \sharety,
  [\mx{s1}{2}, \elab{\locflip}{1}] : \sharety}\\
R &\defeq&  \setit{\elab{\locflip}{1},\elab{\locflip}{2}}
\end{array}
$$
observe we can then obtain share typings for noninteractive components for
addition of shares by \TirName{Shared} and \TirName{HeAdd}:
$$
\Gamma, \toeq{\prog'} \vdash
[\mx{s2}{1} + \elab{\locflip}{1}, \mx{s1}{2} + \elab{\locflip}{2}] : \sharety
$$
and hence for negation by \TirName{HeAddPub}:
$$
\Gamma, \toeq{\prog'} \vdash
[\mx{s2}{1} + \elab{\locflip}{1} + 1, \mx{s1}{2} + \elab{\locflip}{2}] : \sharety
$$
This implies:
$$
\toeq{\prog'} \vdash \varnothing,\varnothing \stredx
\Gamma \cup \setit{\pubx{\px{1} + \px{2}} : \outty}, R 
$$
Hence by \TirName{PubEntails} we have:
$$
\begin{array}{l}
\Gamma \cup \setit{\pubx{\px{1} + \px{2}} : \outty}, \toeq{\prog'} \vdash
\pubx{\out{1}} : \outty \\
\Gamma \cup \setit{\pubx{\px{1} + \px{2}} : \outty}, \toeq{\prog'} \vdash
\pubx{\out{2}} : \outty
\end{array}
$$

\subsection{Share Type Soundness}

\begin{definition}
  We write $\eqs,\Gamma,R : {OK}$ iff both of the following conditions hold:
  \begin{enumerate}[\hspace{5mm}i.]
  \item For all $([\mx{z}{\cid}, \rx{y}{\cid'}] : \sharety) \in \Gamma$,
    we have $\eqs \models \mx{z}{\cid} \eop \phi - \rx{x}{\cid'}$ for
    some $\phi$ and unique $\rx{x}{\cid'} \in R$, with $\cid \ne \cid'$.
  \item For all $([\phi] : \pubty) \in \Gamma$,
    we have $\eqs \models \phi \eop \phi' - \rx{x}{\oid}$ for
    some $\phi'$ and unique $\rx{x}{\oid} \in R$.
  \end{enumerate}
\end{definition}

\begin{lemma}
  Given $\eqs,\Gamma,R  : {OK}$.
  and $\eqs  \vdash \Gamma,R \stredx R',\Gamma'$.
  Then $\eqs, \Gamma',R' : {OK}$.
\end{lemma}

\begin{definition} Define $\ov(\Gamma)$ as follows:
\begin{eqnarray*}
\ov(\varnothing) &=& \varnothing \\[-1.5mm]
\ov(\setit{[\mx{z}{\cid}, \rx{y}{\cid'}] : \sharety} \cup \Gamma) &=& \setit{\mx{z}{\cid}} \cup \ov(\Gamma)\\[-1.5mm]
\ov(\setit{[\px{x} + \px{y}] : \pubty} \cup \Gamma) &=& \setit{\px{x},\px{y}} \cup \ov(\Gamma)\\[-1.5mm]
\ov(\setit{[\out{\cid}] : \outty} \cup \Gamma) &=& \setit{\out{\cid}} \cup \ov(\Gamma)
\end{eqnarray*}
\end{definition}

\begin{lemma}
  Assume given $\Gamma,R, \eqspre \wedge \toeq{\prog} : {OK}_\cid$  and
  $\iov(\prog) = S \cup V \cup O$
  and $\Gamma, \eqspre \wedge \toeq{\prog} \vdash [\phi_1,\phi_2] : \sharety$.
  Then, letting $X \defeq \ov(\Gamma) \cap \realviews{\setit{\cid_1}}{\setit{\cid_2}}$:
  $$
  \condd{\progtt(\prog)}{S_{\setit{\cid_1}}}{S_{\setit{\cid_2}}  \cup X \cup \setit{\phi_1 + \phi_2}}
  = 
  \condd{\progtt(\prog)}{S_{\setit{\cid_1}}}{S_{\setit{\cid_2}} \cup X \cup \setit{\phi_1 + \phi_2, \phi_1}}
  $$
\end{lemma}

\begin{lemma}
  \label{lemma-sty-noninteractive-sound}
  Assume given $\eqspre \wedge \toeq{\prog}, \Gamma,R: {OK}_\cid$  and
  $\iov(\prog) = S \cup V \cup O$
  and $\Gamma, \eqspre \wedge \toeq{\prog} \vdash [\phi_1,\phi_2] : \sharety$.
  Then, letting $X \defeq \ov(\Gamma) \cap \realviews{\setit{\cid_1}}{\setit{\cid_2}}$ for
  $\cid_1 \ne \cid_2$:
  $$
  \condd{\progtt(\prog)}{S_{\setit{\cid_1}}}{S_{\setit{\cid_2}}  \cup X \cup \setit{\phi_1 + \phi_2}}
  = 
  \condd{\progtt(\prog)}{S_{\setit{\cid_1}}}{S_{\setit{\cid_2}} \cup X \cup \setit{\phi_1 + \phi_2, \phi_1}}
  $$
\end{lemma}

\begin{lemma}
  Assume given $\eqspre \wedge \toeq{\prog}, \Gamma_1,R_1: {OK}_\cid$  and
  $\iov(\prog) = S \cup V \cup O$
  and $\eqspre \wedge \toeq{\prog} \vdash \Gamma_1,R_1 \stredx \Gamma_2,R_2$.
  Letting $X_1 \defeq \ov(\Gamma_1) \cap \realviews{\setit{\cid_1}}{\setit{\cid_2}}$,
  for $\cid_1 \ne \cid_2$ assume also:
  $$
  \condd{\progtt(\prog)}{S_{\setit{\cid_1}}}{S_{\setit{\cid_2}}  \cup X_1 \cup O}
  = 
  \condd{\progtt(\prog)}{S_{\setit{\cid_1}}}{S_{\setit{\cid_2}} \cup O}
  $$
  Then, letting $X_2 \defeq \ov(\Gamma_2) \cap \realviews{\setit{\cid_1}}{\setit{\cid_2}}$,
  we have:
  $$
  \condd{\progtt(\prog)}{S_{\setit{\cid_1}}}{S_{\setit{\cid_2}}  \cup X_2 \cup O}
  = 
  \condd{\progtt(\prog)}{S_{\setit{\cid_1}}}{S_{\setit{\cid_2}} \cup O}
  $$
\end{lemma}

\begin{theorem}[Share Type Soundness]
  \label{theorem-sty}
  Assume given $\prog$ with 
  $\iov(\prog) = S \cup V \cup O$
  and $\eqspre \wedge \toeq{\prog} \vdash \varnothing,\varnothing \stredx^*
  \Gamma,R$ where $\realviews{\setit{\cid_1}}{\setit{\cid_2}} \cup O
  \subseteq \ov(\Gamma)$ for all $\cid_1$, $\cid_2$ with $\cid_1 \ne \cid_2$.
  Then $\prog$ satisfies noninterference modulo output.
\end{theorem}
