\section{Share Types}
\label{section-sty}

Our approach to static analysis is to enforce the use of sound
techniques in semi-homorphic encryption in protocols.  As discussed in
the example in Section \ref{section-smt-example}, protocols integrate
interactive elements, such as the sharing of one-time-pad (OTP)
encrypted secrets, and noninteractive elements, such as addition (of
shares). We approach this by introducing distinct judgement forms for
interactive and noninteractive protocol elements. Our type system
as presented will assume 2-client protocols, but this is for
simplicity and the analysis can be generalized to more parties. 

Both interactive and non-interactive judgements leverage the use
of SMT interpretations as described in Section \ref{section-smt}.
We introduce a \emph{share type} language $\sty$, classifying
\emph{share terms}. We represent share terms using standard notation
\cite{10.1007/978-3-030-68869-1_3}. A share term $[\phi_1,\phi_2]$
represents a secret-shared value where client 1 has $\phi_1$ and
client 2 has $\phi_2$, and this shared value can be reconstructed
as $\phi_1 + \phi_2$.\cnote{Comment on generation and
  reconstruction in general somewhere before this section?.} A
share term $\pubx{\phi}$ denotes a publicly shared value.
$$
\begin{array}{rcl@{\hspace{10mm}}l}
  \sty &::=& \sharety \mid \pubty \mid \outty & \textit{share types} \\
  \stt &::=& [\phi,\phi] \mid \pubx{\phi} & \textit{share terms} 
\end{array}
$$
Intuitively, the meaning of share types $\sty$ are as follows.
When we ascribe the type $[\phi_1,\phi_2] : \sharety$, this
means that $[\phi_1,\phi_2]$ are shares of their
reconstruction, which we can represent as $\phi_1 + \phi_2$
as discussed in Section \ref{???}. 
In particular, each of $\phi_1$ and $\phi_2$ independently
reveal nothing about $\phi_1 + \phi_2$. Likewise,
$\pubx{\phi} : \outty$ means that $\phi$ has been
publicly \emph{revealed} via broadcast shares, and our
type system requires that $\phi \eop \phi_1 + \phi_2$ with
$[\phi_1,\phi_2] : \sharety$. This implies that the
process of revealing $\phi$ reveals nothing besides $\phi$.
The ascription $\pubx{\phi} : \pubty$ is similar, with the
additional meaning that $\phi$ is a publicly-known value
independent of any client inputs. This includes known
constant values used in protocols, and more interestingly
\emph{secure openings}. Secure openings are commonly used
to interactively compute public values that are masked with
OTPs secret-shared with clients in initialization protocols,
as for example in Beaver Triple multiplication which
we discuss in Section \ref{section-examples}.

\stylocalfig

We proceed by formally describing the type analysis, then
discussing an illustrative example, and finally by demonstrating share
type soundness in Theorem \ref{theorem-sty}. This result shows that
our analysis enforces noninterference modulo output, in contrast to
the previous system for $\minicat$ that only enforce a gradual release
property \cite{skalka-near-esop25}. By connecting this analysis with
protocol correctness properties enforced by the Hoare logic discussed
in Section \ref{section-smt}, the output can also be connected to an
intended ideal functionality.\cnote{Update intro grid accordingly.}

\subsection{Non-Interactive Typing Rules}

Our non-interactive typing rules are presented in Figure
\ref{fig-stylocal}. Judgmements are of the form $\Gamma, \eqs \vdash
\stt : \sty$, where $\Gamma$ is a set of \emph{share type bindings} of
the form $\stt : \sty$. In the context of typing a protocol $\prog$
soundness requires that the constraint $\eqs$ must be entailed by
$\eqspre \wedge \toeq{\prog}$ (see, e.g., Lemma
\ref{lemma-sty-noninteractive-sound}).

The syntax-directed rules are all known semi-homomorphic operations,
including addition of shares (\TirName{HEAdd}), and both addition and
multiplication of shares with a public value (\TirName{HEAddPub} and
\TirName{HEMultPub}, respectively) \cite{10.1007/978-3-030-68869-1_3}.
These rules also leverage SMT entailment in the \TirName{ShareEntails}
and \TirName{PubEntails} rules, since these operations should be
allowable up to algebraic equivalence in the context of a protocol.

\subsection{Interactive Typing Rules} 

As discussed in Section \ref{???}, a \emph{secret sharing scheme}
includes functions $(\genshares,\recon)$ which generate
and reconstruct shares, respectively.
It is well-known that adding or subtracting a sample from a uniform
distribution in a finite field yields a value in a uniform
distribution, meaning that samples can be used as OTPs with
perfect secrecy \cite{barthe2019probabilistic,darais2019language}.
So we can define:
\begin{eqnarray*}
  \genshares(\phi) &\defeq& [\phi - \rx{y}{\cid_2}, \rx{y}{\cid_2}]\\
  \recon([\phi_1,\phi_2]) &\defeq& \phi_1 \fplus \phi_2
\end{eqnarray*}
where we require that $\genshares$ consumes the randomness
$\setit{\rx{y}{\cid_2}}$ for use as an OTP. 

Of course, there are other methods for encrypting values in MPC
protocols that can be shown to be algebraically equivalent
to this fundamental schema. For example, in Yao's Garbled Circuits
(YGC) in $\mathbb{F}_{2}$, the ``garbler'' represents encrypted wire
values as a random sample (for 1) or its negation (for 0), and shares
its secret input encoding with the ``evaluator'' by using
it as a selection bit. That is, assuming that client 2 is the garbler and
client 1 is the evaluator, we can define:
$$
\xassign{\mx{w}{1}}{\mux{\secret{w}}{\flip{w}}{\neg\flip{w}}}{2}
$$
where for all $\be_1,\be_2,\be_3$ (with $\neg$ denoting negation in $\mathbb{F}_2$):
$$
\mux{\be_1}{\be_2}{\be_3} \defeq (\neg\be_1 \ftimes \be_2) \fplus (\be_1 \ftimes \be_3)
$$
and letting this protocol be $\prog$ the following is valid:
\begin{mathpar}
%\toeq{\xassign{\mx{w}{1}}{\OT{\secret{w}}{1}{\neg\flip{w}}{\flip{w}}}{2}}
   \toeq{\prog} \models \mx{w}{1} \eop \sx{w}{2} \fminus \rx{w}{2}
\end{mathpar}
For this reason SMT entailment is also an important enabling technology
for the interactive rules. 

\styinteractivefig

The interactive share typing rules are defined in Figure
\ref{fig-styinteractive}, with judgements of the form $\eqs \vdash
\Gamma_1,R_1, \stredx \Gamma_2,R_2$.  Each such judgement establishes
a sound type binding in $\Gamma_2$ for interactively-defined
variables-- that is, unicast and broadcast messages exchanged between
clients-- assuming the bindings in $\Gamma_1$. In addition to type
bindings, judgments track random variables used as OTPs, allowing us
to use type linearity to enforce one-time usage similar to previous
related work \cite{darais2019language}, where any randomness used in
the typing is not in $R_1$ and added to $R_2$. To this end, in these
rules $\uplus$ is disjoint union.

The \TirName{Share} rule generates the binding $[\mx{z}{\cid_2},
  \rx{y}{\cid_1}] : \sharety$ if this is a secret sharing as defined
by $\genshares$. It also adds $\rx{y}{\cid_1}$ to the set of variables
used as OTPs, ensuring that it has not already been used. The
\TirName{Reveal} rule generates the binding $\pubx{\px{x} + \px{y}} :
\outty$ with the requirement that $[\px{x},\px{y}]$ are typable as
shares. The \TirName{SecOpen} rule is similar except it allows the
assertion $\pubx{\px{x} + \px{y}} : \pubty$ if we can additionally
show that the shared value is masked by the use of random value
$\rx{z}{\oid}$ as an OTP. Here we are positing a third party $\oid$
that secret-shares $\rx{z}{\oid}$ as part of an initialization
protocol. We illustrate secure openings in practice at more length
in Section \ref{section-examples}, though we note that appropriate
properties of initialization protocols can be encoded in $\eqspre$.

We write $\stredx^*$ to denote the transitive
closure of $\stredx$. For any protocol $\prog$, the goal of the
type analysis is to show that all interactive messages can be classified--
that is, to show that $\eqspre \wedge \toeq{\prog} \vdash
\varnothing,\varnothing \stredx^* \Gamma,R$ where all
interactive messages are classified in $\Gamma$. 


\subsection{Share Typing Example} To illustrate details of the
type system we return to the example of additive sharing in the context
of a 2-client protocol. We first focus on initial secret sharing steps--
let $\prog$ be the following protocol in $\fieldp{2}$ (noting
that $-$ is equivalent to xor in $\fieldp{2}$):
$$
\begin{array}{lll}
  \elab{\mesg{s1}}{2} &:=& \elab{(\secret{1} \fminus \locflip)}{1}; \\
  \elab{\mesg{s2}}{1} &:=& \elab{(\secret{2} \fminus \locflip)}{2} 
\end{array}
$$
We can then assert:
$$
\toeq{\prog} \vdash \varnothing,\varnothing \stredx
\setit{[\mx{s2}{1}, \elab{\locflip}{2}] : \sharety,
  [\mx{s1}{2}, \elab{\locflip}{1}] : \sharety}, \setit{\elab{\locflip}{1},\elab{\locflip}{2}}
$$
Suppose the protocol goes on to reveal the negation of the
sum (xor-ing) of the inputs:
$$
\begin{array}{lll}
  \px{1} &:=& \elab{\mesg{s2} + \locflip + 1}{1}; \\
  \px{2} &:=& \elab{\mesg{s1} + \locflip}{2};\\
  \out{1} &:=& \elab{\px{1} + \px{2}}{1};\\
  \out{2} &:=& \elab{\px{1} + \px{2}}{2}
\end{array}
$$
Letting this extended protocol be $\prog'$, and letting:
$$
\begin{array}{rcl}
\Gamma &\defeq& \setit{[\mx{s2}{1}, \elab{\locflip}{2}] : \sharety,
  [\mx{s1}{2}, \elab{\locflip}{1}] : \sharety}\\
R &\defeq&  \setit{\elab{\locflip}{1},\elab{\locflip}{2}}
\end{array}
$$
observe we can then obtain share typings for noninteractive components for
addition of shares by \TirName{Shared} and \TirName{HeAdd}:
$$
\Gamma, \toeq{\prog'} \vdash
[\mx{s2}{1} + \elab{\locflip}{1}, \mx{s1}{2} + \elab{\locflip}{2}] : \sharety
$$
and hence for negation by \TirName{HeAddPub}:
$$
\Gamma, \toeq{\prog'} \vdash
[\mx{s2}{1} + \elab{\locflip}{1} + 1, \mx{s1}{2} + \elab{\locflip}{2}] : \sharety
$$
This implies:
$$
\toeq{\prog'} \vdash \varnothing,\varnothing \stredx
\Gamma \cup \setit{\pubx{\px{1} + \px{2}} : \outty}, R 
$$
Hence by \TirName{PubEntails} we have:
$$
\begin{array}{l}
\Gamma \cup \setit{\pubx{\px{1} + \px{2}} : \outty}, \toeq{\prog'} \vdash
\pubx{\out{1}} : \outty \\
\Gamma \cup \setit{\pubx{\px{1} + \px{2}} : \outty}, \toeq{\prog'} \vdash
\pubx{\out{2}} : \outty
\end{array}
$$

\subsection{Share Type Soundness}
\label{section-sty-sound}

Now we can prove our share typing soundness result, showing that share
typing enforces noninteference modulo output, with our main result
in Theorem \ref{theorem-sty}. We begin by defining a key well-formedness
property of typing components that we show is preserved by non-interactive
typing judgements.

\begin{definition}
  Given $\prog,\Gamma,R$ where $\secrets(\prog) = S$ and:
  $$
  \Gamma = \setit{[\phi_1^1,\phi_1^2] : \sharety, \ldots, [\phi_n^1,\phi_n^2] : \sharety}
  \cup \setit{\pubx{\phi_1} : \pubty,\ldots,\pubx{\phi_j} : \pubty} \cup
  \setit{\pubx{\phi^o_1} : \outty,\ldots,\pubx{\phi^o_k} : \outty}
  $$
  Then we write $\prog,\Gamma,R : {OK}$ iff all of the following conditions
  hold:
  \begin{enumerate}[\hspace{5mm}i.]
  \item For all $a,b \in \setit{1,2}$ we have
    $
    \condd{\progtt(\prog)}{S_{\setit{\cid_a}}}{S_{\setit{\cid_b}} \cup \setit{\phi^o_1,\ldots,\phi^o_k}}
    = 
    \condd{\progtt(\prog)}{S_{\setit{\cid_a}}}{S_{\setit{\cid_b}} \cup \setit{\phi_1^b,\ldots,\phi_n^b} \cup
      \setit{\phi_1,\ldots,\phi_j} \setit{\phi^o_1,\ldots,\phi^o_k}}
    $.
  \item For all $a,b \in \setit{1,2}$ and $0 < i \le n$ we have
    $\condd{\progtt(\prog)}{S_{\setit{\cid_a}}}{\setit{\phi_i^1 + \phi_i^2}} =
    \condd{\progtt(\prog)}{S_{\setit{\cid_a}}}{\setit{\phi_i^1 + \phi_i^2, \phi_i^a}}$
  \item  For all $a,b \in \setit{1,2}$ and $0 < i \le n$, if
    $\toeq{\prog} \models \phi_i^a \eop \rx{w}{\cid_a} \wedge \phi_i^b \eop \phi - \rx{w}{\cid_a}$ for
    some $\phi$ and $\rx{w}{\cid_a}$ then $\rx{w}{\cid_a} \in R$.
  \item For all $0 < i \le j$, if $\toeq{\prog} \models \phi_i \eop \phi + \rx{w}{\cid_{\oid}}$ for
    some $\phi$  and $\rx{w}{\cid_{\oid}}$ then $\rx{w}{\cid_{\oid}} \in R$.
  \end{enumerate} 
\end{definition}

\begin{lemma}
  \label{lemma-sty-noninteractive-sound}
  Given $\prog,\Gamma,R$ where $\secrets(\prog) = S$ and:
  $$
  \Gamma = \setit{[\phi_1^1,\phi_1^2] : \sharety, \ldots, [\phi_n^1,\phi_n^2] : \sharety}
  \cup \setit{\pubx{\phi_1} : \pubty,\ldots,\pubx{\phi_j} : \pubty} \cup
  \setit{\pubx{\phi^o_1} : \outty,\ldots,\pubx{\phi^o_k} : \outty}
  $$
  and also $\Gamma, \toeq{\prog} \vdash [\phi^1,\phi^2] : \sharety$
  Then for all $a,b \in \setit{1,2}$ the following conditions hold:
    \begin{enumerate}[\hspace{5mm}i.]
    \item $\condd{\progtt(\prog)}{S_{\setit{\cid_a}}}{S_{\setit{\cid_b}} \cup \setit{\phi_1^b,\ldots,\phi_n^b} \cup
      \setit{\phi_1,\ldots,\phi_j} \setit{\phi^o_1,\ldots,\phi^o_k}}
    =
    \condd{\progtt(\prog)}{S_{\setit{\cid_a}}}{S_{\setit{\cid_b}} \cup \setit{\phi_1^b,\ldots,\phi_n^b,\phi^b} \cup
       \setit{\phi_1,\ldots,\phi_j} \setit{\phi^o_1,\ldots,\phi^o_k}}$
    \item $\condd{\progtt(\prog)}{S_{\setit{\cid_a}}}{\setit{\phi_i^1 + \phi_i^2}} =
      \condd{\progtt(\prog)}{S_{\setit{\cid_a}}}{\setit{\phi_i^1 + \phi_i^2, \phi_i^a}}$
    \end{enumerate}
\end{lemma}

\begin{lemma}
  Given $\prog,\Gamma_1,R_1  : {OK}$
  and $\toeq{\prog}  \vdash \Gamma_1, R_1 \stredx \Gamma_2, R_2$.
  Then $\toeq{\prog}, \Gamma_2, R_2 : {OK}$.
\end{lemma}

\begin{definition}
  Given  $\prog,\Gamma,R  : {OK}$ and $\iov(\prog) = S \cup V \cup O$.
  Then $\Gamma$ is \emph{closed for $\prog$} iff for all $H,C$,
  for all $x \in \houtputs$ there exists $\phi$ such that either
  $\Gamma,\toeq{\prog} \vdash [x,\phi] : \sharety$ if $C = \setit{1}$
  or  $\Gamma,\toeq{\prog} \vdash [\phi,x] : \sharety$ if $C = \setit{2}$,
  and for all $\out{\cid} \in O$ we have $\Gamma,\toeq{\prog} \vdash \pubx{\out{\cid}} : \outty$.
\end{definition}

\begin{theorem}
  If $\prog,\Gamma,R : {OK}$ and $\Gamma$ is closed
  for $\prog$, then $\prog$ satisfies noninterference modulo output. 
\end{theorem}

\begin{theorem}
  If $\toeq{\prog} \vdash \varnothing,\varnothing \stredx \Gamma,R$ and $\Gamma$ is closed
  for $\prog$, then $\prog$ satisfies noninterference modulo output. 
\end{theorem}

% DEPRECATED
\begin{comment}
\begin{definition}
  We write $\eqs,\Gamma,R : {OK}$ iff both of the following conditions hold:
  \begin{enumerate}[\hspace{5mm}i.]
  \item For all $([\phi_1,\phi_2] : \sharety) \in \Gamma$,
    we have $\eqs \models \phi_1 \eop \phi - \rx{x}{\cid'} \wedge
    \phi_2 \eop \rx{y}{\cid'}$ for
    some $\phi$ and unique $\rx{x}{\cid'} \in R$, with $\cid \ne \cid'$.
  \item For all $(\pubx{\phi} : \pubty) \in \Gamma$,
    we have $\eqs \models \phi \eop \phi' - \rx{x}{\oid}$ for
    some $\phi'$ and unique $\rx{x}{\oid} \in R$.
  \end{enumerate}
\end{definition}

\begin{lemma}
  Given $\eqs,\Gamma,R  : {OK}$.
  and $\eqs  \vdash \Gamma,R \stredx R',\Gamma'$.
  Then $\eqs, \Gamma',R' : {OK}$.
\end{lemma}

Next, we make a simple definition to formalize what we mean by the interactive
variables in the share type environment $\Gamma$.
\begin{definition} Define $\ov(\Gamma)$ as follows:
\begin{eqnarray*}
\ov(\varnothing) &=& \varnothing \\[-1.5mm]
\ov(\setit{[\mx{z}{\cid}, \rx{y}{\cid'}] : \sharety} \cup \Gamma) &=& \setit{\mx{z}{\cid}} \cup \ov(\Gamma)\\[-1.5mm]
\ov(\setit{[\px{x} + \px{y}] : \pubty} \cup \Gamma) &=& \setit{\px{x},\px{y}} \cup \ov(\Gamma)\\[-1.5mm]
\ov(\setit{[\out{\cid}] : \outty} \cup \Gamma) &=& \setit{\out{\cid}} \cup \ov(\Gamma)
\end{eqnarray*}
\end{definition}
Given the above, we can formulate our key Lemma about noninteractive typing
judgements, which tells us that individual shares in isolation don't reveal anything
about their reconstruction. This result follows by Theorem \ref{theorem-toeq}
and known homomorphic properties of secret sharing schemes. 
\begin{lemma}
  \label{lemma-sty-noninteractive-sound}
  Assume given $\eqspre \wedge \toeq{\prog}, \Gamma,R: {OK}$  and
  $\iov(\prog) = S \cup V \cup O$
  and $\Gamma, \eqspre \wedge \toeq{\prog} \vdash [\phi_1,\phi_2] : \sharety$.
  Then, letting $X \defeq \ov(\Gamma) \cap \realviews{\setit{\cid_1}}{\setit{\cid_2}}$ for
  $\cid_1 \ne \cid_2$:
  $$
  \condd{\progtt(\prog)}{S_{\setit{\cid_1}}}{S_{\setit{\cid_2}}  \cup X \cup \setit{\phi_1 + \phi_2}}
  = 
  \condd{\progtt(\prog)}{S_{\setit{\cid_1}}}{S_{\setit{\cid_2}} \cup X \cup \setit{\phi_1 + \phi_2, \phi_1}}
  $$
\end{lemma}

Based on the preceding Lemma, we can show that noninterence with respect
to classified interactive variables is maintained by typing judgements. 
\begin{lemma}
  \label{lemma-styinteractive}
  Assume given $\eqspre \wedge \toeq{\prog}, \Gamma_1,R_1: {OK}$  and
  $\iov(\prog) = S \cup V \cup O$
  and $\eqspre \wedge \toeq{\prog} \vdash \Gamma_1,R_1 \stredx \Gamma_2,R_2$.
  Letting $X_1 \defeq \ov(\Gamma_1) \cap \realviews{\setit{\cid_1}}{\setit{\cid_2}}$,
  for $\cid_1 \ne \cid_2$ assume also:
  $$
  \condd{\progtt(\prog)}{S_{\setit{\cid_1}}}{S_{\setit{\cid_2}}  \cup X_1 \cup O}
  = 
  \condd{\progtt(\prog)}{S_{\setit{\cid_1}}}{S_{\setit{\cid_2}} \cup O}
  $$
  Then, letting $X_2 \defeq \ov(\Gamma_2) \cap \realviews{\setit{\cid_1}}{\setit{\cid_2}}$,
  we have:
  $$
  \condd{\progtt(\prog)}{S_{\setit{\cid_1}}}{S_{\setit{\cid_2}}  \cup X_2 \cup O}
  = 
  \condd{\progtt(\prog)}{S_{\setit{\cid_1}}}{S_{\setit{\cid_2}} \cup O}
  $$
\end{lemma}
Now we can prove our main Theorem, which follows immediately 
by Lemma \ref{lemma-styinteractive} and induction on $|\Gamma|$
(i.e., the number of bindings in the environment $\Gamma$ obtained
by a complete typing). 
\begin{theorem}[Share Type Soundness]
  \label{theorem-sty}
  Assume given $\prog$ with 
  $\iov(\prog) = S \cup V \cup O$
  and $\eqspre \wedge \toeq{\prog} \vdash \varnothing,\varnothing \stredx^*
  \Gamma,R$ where $\realviews{\setit{\cid_1}}{\setit{\cid_2}} \cup O
  \subseteq \ov(\Gamma)$ for all $\cid_1$, $\cid_2$ with $\cid_1 \ne \cid_2$.
  Then $\prog$ satisfies noninterference modulo output.
\end{theorem}
\end{comment}
